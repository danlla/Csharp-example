name: CD

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            APP_DIR="/home/lisich/Desktop/OIS_Csharp-example"
            LOG_FILE="/home/lisich/Desktop/deploy.log"
            SERVICE="csharp-example"

            echo "=== DEPLOYMENT STARTED ===" > $LOG_FILE
            echo "Time: $(date)" >> $LOG_FILE

            cd "$APP_DIR"

            echo "ðŸ“¦ Pulling latest code..." | tee -a $LOG_FILE
            git pull

            cd "ExampleWebService"

            echo "ðŸ”§ Building project..." | tee -a $LOG_FILE
            dotnet build --configuration Release >> $LOG_FILE 2>&1

            echo "ðŸš€ Restarting service..." | tee -a $LOG_FILE
            sudo /usr/bin/systemctl restart $SERVICE

            echo "âœ… Service status:" | tee -a $LOG_FILE
            sudo systemctl status $SERVICE --no-pager >> $LOG_FILE

            echo "ðŸŽ‰ DEPLOYMENT COMPLETED $(date)" | tee -a $LOG_FILE
